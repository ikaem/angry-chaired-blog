<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!--Description-->

    

    
        <meta name="description" content="Inexperienced and curious pokes into the sprawling world of web development "/>
    

    <!--Author-->
    
        <meta name="author" content="kaem"/>
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="GraphQL &amp; React &amp; JWT: Login Functionality"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="Inexperienced and curious pokes into the sprawling world of web development "/>
    

    <!--Open Graph Site Name-->
        <meta property="og:site_name" content="Angry Chaired Blog"/>

    <!--Type page-->
    
        <meta property="og:type" content="article"/>
    

    <!--Page Cover-->
    
    
        <meta property="og:image" content="https://ikaem.github.io/angry-chaired-blog/angry-chaired-blog/images/header-image.jpg"/>
    

        <meta name="twitter:card" content="summary_large_image"/>

    

    
        <meta name="twitter:image" content="https://ikaem.github.io/angry-chaired-blog/angry-chaired-blog/images/header-image.jpg"/>
    

    <!-- Title -->
    
    <title>GraphQL &amp; React &amp; JWT: Login Functionality - Angry Chaired Blog</title>

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/angry-chaired-blog/css/style.css">

    
<link rel="stylesheet" href="/angry-chaired-blog/css/custom-style.css">


    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css"/>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet"/>

    <!-- Google Analytics -->
    


    <!-- favicon -->
    
    <link rel="icon" href="/angry-chaired-blog/images/favicon.ico"/>
    

<meta name="generator" content="Hexo 5.0.2"><link rel="alternate" href="/angry-chaired-blog/atom.xml" title="Angry Chaired Blog" type="application/atom+xml">
</head>


<body>

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/angry-chaired-blog/">Angry Chaired Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li class="">
                        <a href="/angry-chaired-blog/">
                            
                                Home
                            
                        </a>
                    </li>
                
                    <li class="">
                        <a href="/angry-chaired-blog/archives">
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="">
                        <a href="/angry-chaired-blog/about">
                            
                                About
                            
                        </a>
                    </li>
                
                    <li class="">
                        <a href="/angry-chaired-blog/categories">
                            
                                Categories
                            
                        </a>
                    </li>
                
                    <li class="icon-label">
                        <a target="_blank" rel="noopener" href="https://angrychaired.surge.sh">
                            
                                <i class="fa fa-user fa-stack-2x"></i>
                            
                        </a>
                    </li>
                
                    <li class="icon-label">
                        <a target="_blank" rel="noopener" href="https://github.com/ikaem/">
                            
                                <i class="fa fa-github fa-stack-2x"></i>
                            
                        </a>
                    </li>
                
                    <li class="icon-label">
                        <a href="/angry-chaired-blog/atom.xml">
                            
                                <i class="fa fa-rss fa-stack-2x"></i>
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('jeffrey-f-lin-D4DBJk5UmFo-unsplash.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>GraphQL & React & JWT: Login Functionality</h1>

                    <span class="meta">
                        <!-- Date and Author -->
                        
                        
                            16/08/2020
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           
                <div class="col-lg-4 col-md-5 post-categories">
                    
                        

<a href="/angry-chaired-blog/categories/graphql-react-jwt/">graphql & react & jwt</a>

                    
                </div>
            

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <!-- Step Content Start -->

<h4 id="Part-8-of-12-in-GraphQL-amp-React-amp-JWT"><a href="#Part-8-of-12-in-GraphQL-amp-React-amp-JWT" class="headerlink" title="Part 8 of 12 in GraphQL &amp; React &amp; JWT"></a>Part 8 of 12 in GraphQL &amp; React &amp; JWT</h4><p>Now that we have setup our Apollo Client to use our headers and cookies, we can finally start to implement uathentication features.<br>First one is the <strong>login</strong> one.<br>To login a user, we make use of the <strong>login</strong> mutation we already have prepared on the backend. So that part is done.</p>
<a id="more"></a>

<h4 id="See-Project-Information"><a href="#See-Project-Information" class="headerlink" title="See Project Information"></a>See <a href="#Project-Information">Project Information</a></h4><h2 id="Step-8-Create-login-functionality"><a href="#Step-8-Create-login-functionality" class="headerlink" title="Step 8. Create login functionality"></a>Step 8. Create login functionality</h2><p>On the frontend side, we have to have gather data from a form, and then submit it to the backend mutation somehow. We also need to implement some kind of validation to make sure both email and password are valid values, and we also have to react to successful and unsuccessful mutations. Once the mutation succeeds, we will have the returned data stored into cache, and use it in the Header component to show the logged user’s name and avatar. </p>
<p>Here is a more detailed plan:</p>
<ol>
<li>Create login component</li>
<li>Gather user input for mutation submission and make sure it is valid</li>
<li>Create the mutation query, implement the <strong>useMutation</strong> hook with the <strong>onError</strong> options object property, and call mutation method inside the submit handler</li>
<li>Update Apollo Client cache on successful mutation</li>
<li>Use login data from the cache in the Header component</li>
<li>Redirect client on successful mutation</li>
</ol>
<h3 id="Create-login-component"><a href="#Create-login-component" class="headerlink" title="Create login component"></a>Create login component</h3><p>We will only briefly show the component. It is one of the app’s <strong>page</strong> components, and it directly renders the login form, instead of housing a separate view component. We do this for the sake of practicality, even though a common practice would probably be to separate logic and presentation.</p>
<p>We have a simple form with imputs for email and password, and a button to submit the login details. Email and password inputs have <strong>required</strong> attribute to make sure they hold truthy values before they are submitted.<br>The component is styled with the <strong>styled-components</strong> package, but that is not part of this series.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// login-page.ts</span></span><br><span class="line"><span class="keyword">const</span> LoginPage = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Layout&gt;</span><br><span class="line">      &lt;LoginStyled&gt;</span><br><span class="line">        &lt;section className=<span class="string">&quot;main-content__login-section&quot;</span>&gt;</span><br><span class="line">          &lt;h1 className=<span class="string">&quot;login-section__title&quot;</span>&gt;Login&lt;/h1&gt;</span><br><span class="line">          &lt;form className=<span class="string">&quot;login-section__login-form&quot;</span>&gt;</span><br><span class="line">            &lt;label htmlFor=<span class="string">&quot;email&quot;</span> className=<span class="string">&quot;login-form__label&quot;</span>&gt;</span><br><span class="line">              Email</span><br><span class="line">            &lt;/label&gt;</span><br><span class="line">            &lt;input</span><br><span class="line">              type=<span class="string">&quot;email&quot;</span></span><br><span class="line">              id=<span class="string">&quot;email&quot;</span></span><br><span class="line">              name=<span class="string">&quot;email&quot;</span></span><br><span class="line">              className=<span class="string">&quot;login-form__input&quot;</span></span><br><span class="line">              required</span><br><span class="line">            /&gt;</span><br><span class="line">            &lt;label htmlFor=<span class="string">&quot;password&quot;</span> className=<span class="string">&quot;login-form__label&quot;</span>&gt;</span><br><span class="line">              Password</span><br><span class="line">            &lt;/label&gt;</span><br><span class="line">            &lt;input</span><br><span class="line">              type=<span class="string">&quot;password&quot;</span></span><br><span class="line">              id=<span class="string">&quot;password&quot;</span></span><br><span class="line">              name=<span class="string">&quot;password&quot;</span></span><br><span class="line">              className=<span class="string">&quot;login-form__input&quot;</span></span><br><span class="line">              required</span><br><span class="line">            /&gt;</span><br><span class="line">            &lt;button type=<span class="string">&quot;submit&quot;</span> className=<span class="string">&quot;login-form__login-button&quot;</span>&gt;</span><br><span class="line">              Login</span><br><span class="line">            &lt;/button&gt;</span><br><span class="line">          &lt;/form&gt;</span><br><span class="line">        &lt;/section&gt;</span><br><span class="line">      &lt;/LoginStyled&gt;</span><br><span class="line">    &lt;/Layout&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="Gather-user-input-for-mutation-submission-and-make-sure-it-is-valid"><a href="#Gather-user-input-for-mutation-submission-and-make-sure-it-is-valid" class="headerlink" title="Gather user input for mutation submission and make sure it is valid"></a>Gather user input for mutation submission and make sure it is valid</h3><p>Normally, I do form data collection with state, making a 2-way connection between the state and form inputs with the <strong>value</strong> attribute and <strong>onChange</strong> event.</p>
<p>Recently I learned that we can use the <strong>onRef</strong> hook to collect data from inputs as well, so we will implement the hook here to see how it works.</p>
<p>As far as the validation go, we will not go too deep into it. Proper input validation would mean checking if provided email address has a true email format, and that a password holds certain number of characters, and includes whatever type of characters we decide. Yes, a topic for another post series.<br>Instead, we will only use TS to make sure inputs are provided.</p>
<h4 id="Gather-user-input"><a href="#Gather-user-input" class="headerlink" title="Gather user input"></a>Gather user input</h4><p>To gather data provided by the user, we will use the the <strong>useRef</strong> hook, provided by React itself.</p>
<p>When used, the hook returns a regular JS object holding a <strong>current</strong> property. This property is initialized to whatever was passed to the hook in the first place.<br>This process effectively creates a reference object.</p>
<p>Two important things reagrding the hook are:</p>
<ol>
<li>The object returned by the hook will live for the entirety of its components’s life</li>
<li>Mutation of the <strong>current</strong> property does not cause the component to re-render</li>
</ol>
<p>Here is an example:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useRef &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> LoginPage = <span class="function">() =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> test = useRef(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;test useRef return:&quot;</span>, test); <span class="comment">// &#123; current: &quot;test&quot; &#125;</span></span><br></pre></td></tr></table></figure>

<p>To gather data from an input element, we would attach the element to this reference by adding as a value to the element’s <strong>ref</strong> attribute</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useRef &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> LoginPage = <span class="function">() =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> test = useRef(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        &lt;input id=<span class="string">&quot;test-input&quot;</span> ref=&#123;test&#125;&gt;</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<p>Note that we initialized the reference as <strong>null</strong> because when the component mounts, it doesn’t render any HTML yet.</p>
<p>Now we have access to the <strong>test-input</strong> input, and we can get its value via the <strong>test</strong> reference object’s <strong>current</strong> property. This property will mutate from <strong>null</strong> to eventually hold the entire <strong>test-input</strong> element.<br>Because we now have the <strong>current</strong> property referencing the input element, we can also access the lement’s <strong>value</strong> property.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useRef &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> LoginPage = <span class="function">() =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> test = useRef(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(test.current);</span><br><span class="line">    <span class="comment">// null</span></span><br><span class="line">    <span class="comment">// &lt;input id=&quot;test-input&quot; autocomplete=&quot;off&quot; ...&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        &lt;input id=<span class="string">&quot;test-input&quot;</span> ref=&#123;test&#125;&gt;</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<p>Let’s now use this to get access to our email and password’s input values.</p>
<p>We create references for our email and password inputs, and initialize them to <strong>null</strong> to start with. Note that we are using a concrete type on the hook to make sure our <strong>current</strong> property is of <strong>HTMLInputElement</strong> type.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// login.page.ts</span></span><br><span class="line"><span class="keyword">const</span> LoginPage = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> emailInputRef = useRef&lt;HTMLInputElement&gt;(<span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">const</span> passwordInputRef = useRef&lt;HTMLInputElement&gt;(<span class="literal">null</span>);</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>Next, we attach our input elements to the references we just created, to make sure that the reference object’s <strong>current</strong> property holds our input elements:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// login.page.ts</span></span><br><span class="line"><span class="keyword">const</span> LoginPage = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        ...</span><br><span class="line">        &lt;form className=<span class="string">&quot;login-section__login-form&quot;</span> onSubmit=&#123;handleSubmit&#125;&gt;</span><br><span class="line">            &lt;label htmlFor=<span class="string">&quot;email&quot;</span> className=<span class="string">&quot;login-form__label&quot;</span>&gt;</span><br><span class="line">                Email</span><br><span class="line">            &lt;/label&gt;</span><br><span class="line">            &lt;input</span><br><span class="line">                ...</span><br><span class="line">                ref=&#123;emailInputRef&#125;</span><br><span class="line">                ...</span><br><span class="line">            /&gt;</span><br><span class="line">            &lt;label htmlFor=<span class="string">&quot;password&quot;</span> className=<span class="string">&quot;login-form__label&quot;</span>&gt;</span><br><span class="line">            Password</span><br><span class="line">            &lt;/label&gt;</span><br><span class="line">            &lt;input</span><br><span class="line">                ...</span><br><span class="line">            ref=&#123;passwordInputRef&#125;</span><br><span class="line">                ...</span><br><span class="line">            /&gt;</span><br><span class="line">        ...</span><br><span class="line">    )</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<h4 id="Make-sure-inputs-are-valid"><a href="#Make-sure-inputs-are-valid" class="headerlink" title="Make sure inputs are valid"></a>Make sure inputs are valid</h4><p>We will only make sure our inputs have truthy values. HTML itself is already doing some of the validation work with the <strong>required</strong> attribute being applied to the input elements, but I don’t think these two validation parts would be enough for real, production application. Still, it is enough here.</p>
<p>We will place this validation in a submit handler function. The submit handler will eventuall be used to actually submit mutation to the backend too, but for now we will only use it to make sure we have valid input data.</p>
<p>The handler will be called by a submit event on the form element, getting the event passed to it.<br>Then, we will extract input values from the references’ value properties, and make sure they are not falsy. </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// login.page.ts</span></span><br><span class="line"><span class="keyword">const</span> LoginPage = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">const</span> handleSubmit = <span class="function">(<span class="params">e: React.FormEvent&lt;HTMLFormElement&gt;</span>) =&gt;</span> &#123;</span><br><span class="line">        e.preventDefault();</span><br><span class="line">        <span class="keyword">const</span> enteredEmail = (emailInputRef.current <span class="keyword">as</span> HTMLInputElement).value;</span><br><span class="line">        <span class="comment">// const enteredEmail = emailInputRef.current.value; // error, warning that the current property is possibly null</span></span><br><span class="line">        <span class="comment">// const enteredEmail = emailInputRef.current?.value; / no error here</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> enteredPassword = (passwordInputRef.current <span class="keyword">as</span> HTMLInputElement)</span><br><span class="line">            .value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!enteredEmail || !enteredPassword) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;enteredEmail:&quot;</span>, enteredEmail);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;enteredPassword:&quot;</span>, enteredPassword);</span><br><span class="line">    &#125;;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>Note that, when asssigning values to our <strong>entered</strong> variables, we are casting the <strong>current</strong> properties as <strong>HTMLInputElement</strong>. We are doing this to avoid the error where the <strong>current</strong> propert is possibly <strong>null</strong>. TS is warning us about this because we initialized our references with <strong>null</strong> values. However, at this point, when our <strong>handleSubmit</strong> function gets called, the references will already be pointing to input elements and have a truthy <strong>current</strong> values.<br>I commented out the syntax that will cause the error, as well as another possible solution with conditionally evaluating the <strong>current</strong> property.</p>
<p>With this setup, we also set the function to return if either of the two <strong>entered</strong> constants are falsy, or log their values if all is good. </p>
<h3 id="Create-the-mutation-query-implement-the-useMutation-hook-with-the-onError-options-object-property-and-call-mutation-method-inside-the-submit-handler"><a href="#Create-the-mutation-query-implement-the-useMutation-hook-with-the-onError-options-object-property-and-call-mutation-method-inside-the-submit-handler" class="headerlink" title="Create the mutation query, implement the useMutation hook with the onError options object property, and call mutation method inside the submit handler"></a>Create the mutation query, implement the <strong>useMutation</strong> hook with the <strong>onError</strong> options object property, and call mutation method inside the submit handler</h3><p>Title of the section makes it obvious that we will do three things here:</p>
<ol>
<li>Create mutation query</li>
<li>Implement the <strong>useMutation</strong> hook</li>
<li>Have the mutation method called inside the <strong>handleSubmit</strong> function</li>
</ol>
<h4 id="Mutation-query"><a href="#Mutation-query" class="headerlink" title="Mutation query"></a>Mutation query</h4><p>The mutation query is simple, and we have done this before. You probably have it laying forgotten in the <strong>GraphQL Playground</strong> from when we tested <strong>login</strong> resolver on the backend.</p>
<p>We define two variables inside the mutation query, both mandatory and both strings. Then we use those variables in the mutation. We will give values to those variables later when we call the mutation method.<br>Finally, we request logged user’s name, avatar link and access token back from the mutation. </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// login.page.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; gql &#125; <span class="keyword">from</span> <span class="string">&quot;@apollo/client&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> LOGIN_MUTATION_QUERY = gql<span class="string">`</span></span><br><span class="line"><span class="string">    mutation Login($email: String!, $password: String!) &#123;</span></span><br><span class="line"><span class="string">        login(email: $email, password: $password) &#123;</span></span><br><span class="line"><span class="string">            first_name</span></span><br><span class="line"><span class="string">            avatar_link</span></span><br><span class="line"><span class="string">            access_token</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">`</span>;</span><br></pre></td></tr></table></figure>

<h4 id="Implement-the-useMutation-hook"><a href="#Implement-the-useMutation-hook" class="headerlink" title="Implement the useMutation hook"></a>Implement the <strong>useMutation</strong> hook</h4><p>We have done this part before, too. We will pass our mutation to the <strong>useMutation</strong> hook, and we will destructure the mutation method from the hook’s return return.<br>We do not need the actual data in this case, as we will not be rendering the returned data directly.</p>
<p>We will, however, define a concrete type to be used by the hook, instead of its default generic type. We will do it to get the TS support and autocompletion featrues for the returned data, to use later when updating cache. </p>
<p>First, lets define the type as an interface.<br>We know that the data returned from the <strong>login</strong> mutation is of <strong>Me</strong> type, as defined by our GQL types on backend.<br>The <strong>Me</strong> type returns logged user’s first name, avatar link, access token, as well as the <strong>__typename</strong> property holding name of the type - “Me”. </p>
<p>The interface, therefore, can look like this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// login.page.ts</span></span><br><span class="line">interface LoggedUserInterface &#123;</span><br><span class="line">    login: &#123;</span><br><span class="line">        __typename: string;</span><br><span class="line">        first_name: string;</span><br><span class="line">        avatar_link: string;</span><br><span class="line">        access_token: string;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Let’s implement the <strong>useMutation</strong> hook now.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// login.page.ts</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">const</span> [ loginMutation ] = useMutation&lt;LoggedUserInterface&gt;(</span><br><span class="line">    LOGIN_MUTATION_QUERY,</span><br><span class="line">    &#123;</span><br><span class="line">        onCompleted: <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;onCompleted data:&quot;</span>, data)</span><br><span class="line">            setDoRedirect(<span class="literal">true</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        onError: <span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;Error:&quot;</span>, error);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;GraphQLErrors:&quot;</span>, error.graphQLErrors);</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>We have also included two methods in the options object passed to the <strong>useMutation</strong> hook:</p>
<ol>
<li><strong>onError</strong> method, as a basic and simple way to get information about any possible errors that might happen.</li>
<li><strong>onCompleted</strong> method, just to temporarily log the data returned by the mutation. The <strong>data</strong> argument** is automatically passed to method once the mutation is complete, holding values returned from the mutatation, and in our case, being of our concrete type that we defined with the <strong>LoggedUserInterface</strong> interface. We will later use this method to redirect user to a different page once the mutation completes successfully. </li>
</ol>
<h4 id="Have-the-mutation-method-called-inside-the-handleSubmit-function"><a href="#Have-the-mutation-method-called-inside-the-handleSubmit-function" class="headerlink" title="Have the mutation method called inside the handleSubmit function"></a>Have the mutation method called inside the <strong>handleSubmit</strong> function</h4><p>We have already prepared our <strong>handleSubmit</strong> function, and we can simply call our method from there.<br>We will need to include varibles in the method’s options object argument, as we defined our mutation query to accept two - email and password. We will get those from our <strong>entered</strong> constants extracted from email and password references.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// login.page.ts</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">const</span> handleSubmit = <span class="function">(<span class="params">e: React.FormEvent&lt;HTMLFormElement&gt;</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    e.preventDefault();</span><br><span class="line">    <span class="keyword">const</span> enteredEmail = (emailInputRef.current <span class="keyword">as</span> HTMLInputElement).value;</span><br><span class="line">    <span class="keyword">const</span> enteredPassword = (passwordInputRef.current <span class="keyword">as</span> HTMLInputElement).value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!enteredEmail || !enteredPassword) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    loginMutation(&#123;</span><br><span class="line">        variables: &#123;</span><br><span class="line">            email: enteredEmail,</span><br><span class="line">            password: enteredPassword,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>Finally, we need to have the <strong>handleSubmit</strong> method be called when we actually click on the login button and submit the form data:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// login.page.js</span></span><br><span class="line"><span class="keyword">return</span> (</span><br><span class="line">    ...</span><br><span class="line">    &lt;form className=<span class="string">&quot;login-section__login-form&quot;</span> onSubmit=&#123;handleSubmit&#125;&gt;</span><br><span class="line">        &lt;label htmlFor=<span class="string">&quot;email&quot;</span> className=<span class="string">&quot;login-form__label&quot;</span>&gt;</span><br><span class="line">            Email</span><br><span class="line">        &lt;/label&gt;</span><br><span class="line">        &lt;input</span><br><span class="line">            type=<span class="string">&quot;email&quot;</span></span><br><span class="line">            id=<span class="string">&quot;email&quot;</span></span><br><span class="line">            name=<span class="string">&quot;email&quot;</span></span><br><span class="line">            className=<span class="string">&quot;login-form__input&quot;</span></span><br><span class="line">            ref=&#123;emailInputRef&#125;</span><br><span class="line">            required</span><br><span class="line">        /&gt;</span><br><span class="line">        &lt;label htmlFor=<span class="string">&quot;password&quot;</span> className=<span class="string">&quot;login-form__label&quot;</span>&gt;</span><br><span class="line">            Password</span><br><span class="line">        &lt;/label&gt;</span><br><span class="line">        &lt;input</span><br><span class="line">            type=<span class="string">&quot;password&quot;</span></span><br><span class="line">            id=<span class="string">&quot;password&quot;</span></span><br><span class="line">            name=<span class="string">&quot;password&quot;</span></span><br><span class="line">            className=<span class="string">&quot;login-form__input&quot;</span></span><br><span class="line">            ref=&#123;passwordInputRef&#125;</span><br><span class="line">            required</span><br><span class="line">        /&gt;</span><br><span class="line">        &lt;button type=<span class="string">&quot;submit&quot;</span> className=<span class="string">&quot;login-form__login-button&quot;</span>&gt;</span><br><span class="line">            Login</span><br><span class="line">        &lt;/button&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">    ...</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>This should be enough. Let’s try and login to see what happens. We expect our <strong>onCompleted</strong> method log the full <strong>Me</strong> type returned by the <strong>login</strong> mutation.</p>
<p>Here it is:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">onCompleted data: </span><br><span class="line">    &#123;<span class="attr">login</span>: &#123;…&#125;&#125;</span><br><span class="line">        login:</span><br><span class="line">            access_token: <span class="string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjcsImlhdCI6MTU5NTM5NzQ3OCwiZXhwIjoxNTk1Mzk5Mjc4fQ.JPPS79eXLlhW7IWXkc4QCILOket8V9hu7QOUlLw_ego&quot;</span></span><br><span class="line">            avatar_link: <span class="string">&quot;https://source.unsplash.com/225x225/?portrait&quot;</span></span><br><span class="line">            first_name: <span class="string">&quot;karlo&quot;</span></span><br><span class="line">            __typename: <span class="string">&quot;Me&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Update-Apollo-Client-cache-on-successful-mutation"><a href="#Update-Apollo-Client-cache-on-successful-mutation" class="headerlink" title="Update Apollo Client cache on successful mutation"></a>Update Apollo Client cache on successful mutation</h3><p>We already have pretty much everything prepared for this part.</p>
<ol>
<li>We have initialized our Apollo Client cache, so we just need to update already existing cache fields</li>
<li>We can perform mutation and we get correct data back from the server</li>
</ol>
<p>We only need to include the <strong>update</strong> method in the options object argument passed to the <strong>useMutation</strong> hook, and use it to write received data to the cache.<br>We do, however, need in instance of our client on which to use the <strong>writeQuery</strong> method to update our cache. The <strong>update</strong> method does get passed a <strong>cache</strong> argument, but we will not use it as the changes we make to cache that way might not be immediately rendered, while the <strong>client</strong> verion will. </p>
<p>We can get access to our instance of the client from the <strong>useMutation</strong> hook, by destructuring it from the returned response object. This object will be <strong>undefined</strong> until we actually sucessfully perform our mutation, hence the <strong>optional chaining operator</strong> - the <strong>?</strong> sign in the body of the <strong>update</strong> method.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// login.page.ts</span></span><br><span class="line"><span class="keyword">const</span> [loginMutation, &#123; client &#125;] = useMutation&lt;LoggedUserInterface&gt;(</span><br><span class="line">    LOGIN_MUTATION_QUERY,</span><br><span class="line">    &#123;</span><br><span class="line">        ...</span><br><span class="line">        update: <span class="function">(<span class="params">_cache, &#123; data &#125;</span>) =&gt;</span> &#123; <span class="comment">// not using the cache argument</span></span><br><span class="line">            client?.writeQuery(&#123;...&#125;)</span><br></pre></td></tr></table></figure>

<p>To update the cache, we will use an options object with the same <strong>query</strong> that we used when we initialized our cache. The <strong>data</strong> object in the options will be of the same shape as the initialized one, too, but we will now assign values from our mutation response to its properties. The one cache field that we do not have in the response, the <strong>isLoggedIn</strong> property, we will just assign a boolean value of <strong>true</strong>, to indicate that there a logged user is now using our app. </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// login.page.ts</span></span><br><span class="line"><span class="keyword">const</span> [loginMutation, &#123; client &#125;] = useMutation&lt;LoggedUserInterface&gt;(</span><br><span class="line">    LOGIN_MUTATION_QUERY,</span><br><span class="line">    &#123;</span><br><span class="line">        ...</span><br><span class="line">            update: <span class="function">(<span class="params">_cache, &#123; data &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">                client?.writeQuery(&#123;</span><br><span class="line">                    query: gql<span class="string">`</span></span><br><span class="line"><span class="string">                        query Login &#123;</span></span><br><span class="line"><span class="string">                            login &#123;</span></span><br><span class="line"><span class="string">                                __typename</span></span><br><span class="line"><span class="string">                                first_name</span></span><br><span class="line"><span class="string">                                avatar_link</span></span><br><span class="line"><span class="string">                                access_token</span></span><br><span class="line"><span class="string">                                isLoggedIn</span></span><br><span class="line"><span class="string">                                refreshRequestHasFinished</span></span><br><span class="line"><span class="string">                            &#125;</span></span><br><span class="line"><span class="string">                        &#125;</span></span><br><span class="line"><span class="string">                    `</span>,</span><br><span class="line">                    data: &#123;</span><br><span class="line">                        login: &#123;</span><br><span class="line">                            __typename: data?.login.__typename,</span><br><span class="line">                            first_name: data?.login.first_name,</span><br><span class="line">                            avatar_link: data?.login.avatar_link,</span><br><span class="line">                            access_token: data?.login.access_token,</span><br><span class="line">                            isLoggedIn: <span class="literal">true</span>,</span><br><span class="line">                        &#125;,</span><br><span class="line">                    &#125;,</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;,</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>

<p>Great. Let’s refresh our app and login again to see what happens with our cache in Apollo Client Developer Tools.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ROOT_QUERY</span><br><span class="line">    login:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;__typename&quot;</span>: <span class="string">&quot;Me&quot;</span>,</span><br><span class="line">            <span class="string">&quot;first_name&quot;</span>: <span class="string">&quot;karlo&quot;</span>,</span><br><span class="line">            <span class="string">&quot;avatar_link&quot;</span>: <span class="string">&quot;https://source.unsplash.com/225x225/?portrait&quot;</span>,</span><br><span class="line">            <span class="string">&quot;access_token&quot;</span>: <span class="string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjcsImlhdCI6MTU5NTQwMDg0MSwiZXhwIjoxNTk1NDAyNjQxfQ.IHNDay4lALabeIYfVO3rqEFM9SkDDEmQKKIVF1JOKDw&quot;</span>,</span><br><span class="line">            <span class="string">&quot;isLoggedIn&quot;</span>: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>Great. Cache has updated, and we have the logged user’s data stored for use throughout the app. </p>
<h3 id="Use-login-data-from-the-cache-in-the-Header-component"><a href="#Use-login-data-from-the-cache-in-the-Header-component" class="headerlink" title="Use login data from the cache in the Header component"></a>Use login data from the cache in the Header component</h3><p>The Header component is the only component (beside the <strong>App</strong> component) always seen in our app. Because of this we will use it to show information about the logged user.</p>
<p>We render current user’s avatar and name in the header. Since there is no logged user when the app runs for the first time, there will be no user data in the cache, so the Header component will render empty strings. This is ok.</p>
<p>In this part we will: </p>
<ol>
<li>Use Apollo hooks in the Header component to fetch information about the logged user from the cache</li>
<li>Render user’s name and avatar in the Header component</li>
</ol>
<h4 id="Use-Apollo-hooks-in-the-Header-component-to-fetch-information-about-the-logged-user-from-the-cache"><a href="#Use-Apollo-hooks-in-the-Header-component-to-fetch-information-about-the-logged-user-from-the-cache" class="headerlink" title="Use Apollo hooks in the Header component to fetch information about the logged user from the cache"></a>Use Apollo hooks in the Header component to fetch information about the logged user from the cache</h4><p>We already have the Header component created, so we will just create our query and implement the <strong>useQuery</strong> hook.<br>I did, however, adjusted the component to be a <strong>container</strong> instead of a plan view component. I changed its file name from <strong>header.component.tsx</strong> to <strong>header.container.tsx</strong>, and moved it from the <strong>components</strong> to <strong>containers</strong> folder.<br>It is mostly a matter of preference, to do with organizing components in a way that those handling logic are considered <strong>containers</strong>, while those dealing only view presentation are <strong>components</strong>. It is a very blurry distinction, especially in this case where our Header does both tasks, but I just prefer to have components with logic sorted under <strong>containers</strong>.</p>
<p>Remember that we are now querying data from the cache, so we need to adjust our query to do so. We do it by adding <strong>@client</strong> after the query name:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// header.container.tsx</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">const</span> GET_LOGGED_USER_AT_CLIENT = gql<span class="string">`</span></span><br><span class="line"><span class="string">    query GetLoggedUserAtClient &#123;</span></span><br><span class="line"><span class="string">        login @client &#123;</span></span><br><span class="line"><span class="string">            first_name</span></span><br><span class="line"><span class="string">            avatar_link</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>Next up, we implement the <strong>useQuery</strong> hook by passing it our query. The hook will query our cache because we included <strong>@client</strong> in the query, and it will always return a response. </p>
<p>Notice that we destructure the <strong>data</strong> property from the response, and then destructure its own properties further down to finally reach <strong>first_name</strong> and <strong>avatar_link</strong> properties. To make TS know that these properties indeed exist, we cast the <strong>useQuery</strong> expression as an object of the same shape as the destructured <strong>data</strong>.<br>We could have also used this same object as a concrete type for the <strong>useQuery</strong> hook, but that would allow for a possibility of <strong>data</strong> being <strong>undefined</strong>, and return destructurig would not be possible in the way we want it.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// header.container.tsx</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">const</span> &#123; <span class="attr">data</span>: &#123; <span class="attr">login</span>: &#123; first_name, avatar_link &#125;&#125;&#125; = useQuery(GET_LOGGED_USER_AT_CLIENT) <span class="keyword">as</span> &#123; <span class="attr">data</span>: &#123; <span class="attr">login</span>: &#123; <span class="attr">first_name</span>: string; avatar_link: string &#125;&#125;&#125;;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h4 id="Render-user’s-name-and-avatar-in-the-Header-component"><a href="#Render-user’s-name-and-avatar-in-the-Header-component" class="headerlink" title="Render user’s name and avatar in the Header component"></a>Render user’s name and avatar in the Header component</h4><p>We have defined <strong>first_name</strong> and <strong>avatar_link</strong> variables, and we can render them in the Header component:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// header.container.tsx</span></span><br><span class="line"><span class="keyword">return</span> (</span><br><span class="line">    &lt;HeaderStyled&gt;</span><br><span class="line">        &lt;div className=<span class="string">&quot;main-header__logo-container&quot;</span>&gt;</span><br><span class="line">            &lt;Link className=<span class="string">&quot;logo-container__logo-link&quot;</span> to=<span class="string">&quot;/home&quot;</span>&gt;</span><br><span class="line">                &lt;h1 className=<span class="string">&quot;logo-container__logo-actual&quot;</span>&gt;GraphQL-JWT&lt;/h1&gt;</span><br><span class="line">            &lt;/Link&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;nav className=<span class="string">&quot;main-header__navigation&quot;</span>&gt;</span><br><span class="line">            &lt;ul className=<span class="string">&quot;navigation__options&quot;</span>&gt;</span><br><span class="line">                &lt;li className=<span class="string">&quot;navigation__option first-option&quot;</span>&gt;</span><br><span class="line">                    &lt;Link className=<span class="string">&quot;option__link-actual&quot;</span> to=<span class="string">&quot;/profile&quot;</span>&gt;</span><br><span class="line">                        &lt;div className=<span class="string">&quot;link-actual__avatar-container&quot;</span>&gt;</span><br><span class="line">                            &lt;img src=&#123;avatar_link&#125; alt=<span class="string">&quot;&quot;</span> /&gt;</span><br><span class="line">                        &lt;/div&gt;</span><br><span class="line">                        &#123;first_name &amp;&amp; (</span><br><span class="line">                            &lt;span className=<span class="string">&quot;link-actual__text&quot;</span>&gt;</span><br><span class="line">                                Hi, &amp;nbsp; <span class="xml"><span class="tag">&lt;<span class="name">strong</span>&gt;</span>&#123;first_name&#125;<span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span></span><br><span class="line">                            &lt;/span&gt;</span><br><span class="line">                        )&#125;</span><br><span class="line">                    &lt;/Link&gt;</span><br><span class="line">                &lt;/li&gt;</span><br></pre></td></tr></table></figure>

<p>Great. Try and login now, and see what happens to the header. Login mutation should result in updating the cache, which should cause the name and avatar to change and update the header.<br>In case no login happens, user image and name have a value of empty string, getting it from the cache initial state. </p>
<h4 id="Redirect-client-on-successful-mutation"><a href="#Redirect-client-on-successful-mutation" class="headerlink" title="Redirect client on successful mutation"></a>Redirect client on successful mutation</h4><p>Once our mutation completes, we want user to actually visit the home page.<br>We can use <strong>React Router</strong>‘s <strong>Redirect</strong> component to do this. We will also need React’s <strong>useState</strong> hook to create one state for the page we want to redirect the client to, and another state to control whether the redirection should happen or not. </p>
<p>We could control both with one state, setting it initially to an empty string (the empty string being a “falsy” value, preventing <strong>Redirect</strong> component from being rendered), and then to <strong>“home</strong> once the mutation completes. This, however, would make it a bit harder to possibly redirect the client to a some other route in a future expansion of the app, so let’s stick with two states.</p>
<p>All of the following code is written in the <strong>Login</strong> component.</p>
<p>Here are the states:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// login.page.tsx</span></span><br><span class="line"><span class="keyword">const</span> LoginPage = <span class="function">() =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> [redirectRoute, setRedirectRoute] = useState&lt;string&gt;(<span class="string">&quot;home&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> [doRedirect, setDoRedirect] = useState&lt;boolean&gt;(<span class="literal">false</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Here is the conditional rendering of the <strong>Redirect</strong> component:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// login.page.tsx</span></span><br><span class="line"><span class="keyword">const</span> LoginPage = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        ...</span><br><span class="line">                    &lt;/section&gt;</span><br><span class="line">                &#123;doRedirect &amp;&amp; <span class="xml"><span class="tag">&lt;<span class="name">Redirect</span> <span class="attr">to</span>=<span class="string">&#123;</span>`/$&#123;<span class="attr">redirectRoute</span>&#125;`&#125; /&gt;</span></span>&#125;</span><br><span class="line">            &lt;/LoginStyled&gt;</span><br><span class="line">        &lt;/Layout&gt;</span><br><span class="line">    )</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>And finally, here is the the <strong>onCompleted</strong> method, setting the <strong>doRedirect</strong> state to true and redirecting the client to the <strong>“/home”</strong> route.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// login.page.ttsx</span></span><br><span class="line"><span class="keyword">const</span> LoginPage = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">const</span> [loginMutation, &#123; client &#125;] = useMutation&lt;LoggedUserInterface&gt;(</span><br><span class="line">        LOGIN_MUTATION_QUERY,</span><br><span class="line">        &#123;</span><br><span class="line">            onCompleted: <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">            setDoRedirect(<span class="literal">true</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<!-- End Step Content -->

<!-- Project Information -->

<h2 id="Project-Information"><a href="#Project-Information" class="headerlink" title="Project Information"></a>Project Information</h2><h3 id="Available-at"><a href="#Available-at" class="headerlink" title="Available at"></a>Available at</h3><p><a target="_blank" rel="noopener" href="https://github.com/ikaem/graphql-jwt-react.git">Github</a> </p>
<h3 id="Goals"><a href="#Goals" class="headerlink" title="Goals"></a>Goals</h3><ol>
<li>Create an app that uses GraphQL and JWT to log in and log out users</li>
<li>Use PSQL for database</li>
<li>Use Typescript on both ends</li>
<li>Use Apollo Client Cache features to store JWT and user info on front end</li>
<li>Implement protected routes, so that only logged users can access certain pages</li>
</ol>
<h3 id="Steps"><a href="#Steps" class="headerlink" title="Steps"></a>Steps</h3><ol>
<li>Create types and queries</li>
<li>Create functions to generate JSON Web Tokens</li>
<li>Create middleware to check if tokens are valid</li>
<li>Set up Apollo Express be able to deal with tokens and cookies</li>
<li>Create resolvers</li>
<li>Set up Apollo Client cache</li>
<li>Set up Apollo Client so we can work with cookies and headers</li>
<li><strong>Create login functionality</strong></li>
<li>Create logout functionality</li>
<li>Create functionality to automatically log in user if they return to our app</li>
<li>Enable silent refresh of access token when it reaches its expiry period</li>
<li>Create register functionality</li>
</ol>
<h3 id="Tech-and-Tools"><a href="#Tech-and-Tools" class="headerlink" title="Tech and Tools"></a>Tech and Tools</h3><ol>
<li>React</li>
<li>Node</li>
<li>PSQL</li>
<li>GraphQL</li>
<li>Apollo Server Express</li>
<li>Apollo Client</li>
<li>Bcrypt</li>
<li>TypeScript</li>
<li>Express</li>
<li>JWT</li>
</ol>
<h3 id="Experience-with-Tech-amp-Tools"><a href="#Experience-with-Tech-amp-Tools" class="headerlink" title="Experience with Tech &amp; Tools"></a>Experience with Tech &amp; Tools</h3><p>This project is a continuation of the <a href="categories/graphql-react-psql/">Graphql &amp; React &amp; Psql series</a>. There, I worked with TS, PSQL and GQL, so I’m ok with that, I guess.<br>I have done some JWT things before, and here I wanted to try it with GQL.</p>
<h2 id="DISCLAIMER"><a href="#DISCLAIMER" class="headerlink" title="DISCLAIMER"></a>DISCLAIMER</h2><p>Don’t take any of this seriously and as a matter-of-fact. These are my notes. It might look like I am trying to teach something to someone. I am not.</p>


                


                <!-- Cover image credit -->
                
                    <p class="image-credit-link">
                        Cover image by <strong>
                            <a target="_blank" rel="noopener" href="https://unsplash.com/@jeffreyflin?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText">
                                Jeffrey F Lin
                            </a>
                        </strong>
                    </p>

                

  

            </div>
            
            <!-- Custom placed tags -->
            <div class="col-lg-4 col-lg-offset-2 col-md-5 col-md-offset-1 post-tags">
                
                    


<a href="/angry-chaired-blog/tags/frontend/">#frontend</a> <a href="/angry-chaired-blog/tags/apollo/">#apollo</a> <a href="/angry-chaired-blog/tags/jwt/">#jwt</a> <a href="/angry-chaired-blog/tags/graphql/">#graphql</a> <a href="/angry-chaired-blog/tags/authentication/">#authentication</a>


                
            </div>
            <!--  -->



            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    


                </div>
            

            <!-- Hyvor comments -->

            <!-- End of Hyvor comments -->
        </div>
    </div>
</article>



    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    

                    

                    

                    

                    

                    
                </ul>
                <p class="copyright text-muted">&copy; 2020 kaem<br></p>
                <p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/">Clean Blog</a> from <a href="http://startbootstrap.com/" target="_blank">Start Bootstrap</a></p>
                <p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/">Hexo</a> by <a href="http://www.codeblocq.com/" target="_blank">Jonathan Klughertz</a></p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->



</body>

</html>